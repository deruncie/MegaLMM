<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Running MegaLMM • MegaLMM</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Running MegaLMM">
<meta property="og:description" content="MegaLMM">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MegaLMM</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/MultiEnvironmentTrial.html">MultiEnvironmentTrial</a>
    </li>
    <li>
      <a href="../articles/Running_MegaLMM.html">Running MegaLMM</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Running MegaLMM</h1>
            
      
      
      <div class="hidden name"><code>Running_MegaLMM.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">MegaLMM</span><span class="op">)</span></span></code></pre></div>
<p>The following code generates simulated data, and then loads it into
the R workspace. It can be skipped if you are loading your own data in a
different way</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seed</span> <span class="op">=</span> <span class="fl">1</span>  <span class="co"># for reproducibility</span></span>
<span><span class="va">nSire</span> <span class="op">=</span> <span class="fl">50</span> <span class="co"># simulation design is a half-sib design: each of nSire fathers has nRep children, each with a different female</span></span>
<span><span class="va">nRep</span> <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="va">nTraits</span> <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="va">nFixedEffects</span> <span class="op">=</span> <span class="fl">2</span> <span class="co"># fixed effects are effects on the factors</span></span>
<span><span class="va">nFactors</span> <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="va">factor_h2s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">nFactors</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.9</span>,<span class="va">nFactors</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>  <span class="co"># factor_h2 is the % of variance in each factor trait that is explained by additive genetic variation.</span></span>
<span><span class="co"># The is after accounting for the fixed effects on the factors</span></span>
<span><span class="va">Va</span> <span class="op">=</span> <span class="fl">2</span> <span class="co"># residual genetic variance in each of the observed traits after accounting for the factors</span></span>
<span><span class="va">Ve</span> <span class="op">=</span> <span class="fl">2</span> <span class="co"># residual microenvironmental variance in each of the observed traits after accounting for the factors</span></span>
<span><span class="va">Vb</span> <span class="op">=</span> <span class="fl">0</span> <span class="co"># magnitude of the fixed effects (just factors)</span></span>
<span><span class="fu">new_halfSib_simulation</span><span class="op">(</span><span class="st">'Sim_FE_1'</span>, nSire<span class="op">=</span><span class="va">nSire</span>,nRep<span class="op">=</span><span class="va">nRep</span>,p<span class="op">=</span><span class="va">nTraits</span>, b<span class="op">=</span><span class="va">nFixedEffects</span>, factor_h2s<span class="op">=</span> <span class="va">factor_h2s</span>,Va <span class="op">=</span> <span class="va">Va</span>, Ve <span class="op">=</span> <span class="va">Ve</span>,Vb <span class="op">=</span> <span class="va">Vb</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">'setup.RData'</span><span class="op">)</span></span>
<span><span class="va">Y</span> <span class="op">=</span> <span class="va">setup</span><span class="op">$</span><span class="va">Y</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">setup</span><span class="op">$</span><span class="va">data</span></span>
<span><span class="va">K</span> <span class="op">=</span> <span class="va">setup</span><span class="op">$</span><span class="va">K</span></span></code></pre></div>
<div class="section level2">
<h2 id="set-the-parameters-of-the-megalmm-model">Set the parameters of the MegaLMM model<a class="anchor" aria-label="anchor" href="#set-the-parameters-of-the-megalmm-model"></a>
</h2>
<p>There are several parameters that control the specific model that
MegaLMM will construct. Most importantly, we need to specify
<code>K</code>, the number of latent factors and
<code>h2_divisions</code>, the number of discrete values between 0 and 1
to evaluate each variance component proportion for each random
effect.</p>
<p>Several other parameters are also necessary and are described in the
help file: <code><a href="../reference/MegaLMM_control.html">?MegaLMM_control</a></code></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">run_parameters</span> <span class="op">=</span> <span class="fu"><a href="../reference/MegaLMM_control.html">MegaLMM_control</a></span><span class="op">(</span></span>
<span>  max_NA_groups <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  scale_Y <span class="op">=</span> <span class="cn">FALSE</span>,   <span class="co"># should the columns of Y be re-scaled to have mean=0 and sd=1?</span></span>
<span>  h2_divisions <span class="op">=</span> <span class="fl">20</span>, <span class="co"># Each variance component is allowed to explain between 0% and 100% of the total variation. How many segments should the range [0,100) be divided into for each random effect?</span></span>
<span>  h2_step_size <span class="op">=</span> <span class="cn">NULL</span>, <span class="co"># if NULL, all possible values of random effects are tried each iteration. If in (0,1), a new candidate set of random effect proportional variances is drawn uniformily with a range of this size</span></span>
<span>  burn <span class="op">=</span> <span class="fl">00</span>,  <span class="co"># number of burn in samples before saving posterior samples</span></span>
<span>  K <span class="op">=</span> <span class="fl">15</span> <span class="co"># number of factors</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="set-the-prior-hyperparameters-of-the-megalmm-model">Set the prior hyperparameters of the MegaLMM model<a class="anchor" aria-label="anchor" href="#set-the-prior-hyperparameters-of-the-megalmm-model"></a>
</h2>
<p>MegaLMM is a Bayesian model, so all unknown parameters require
priors. While all prior distributions can be modified by the user, some
have fixed distributional forms with tunable hyperparameters, while
others are more flexible and take as inputs user-provided functions
(with very strict requirements… advanced users only!).</p>
<ul>
<li>
<code>tot_Y_var</code> is the residual variance of each trait after
accounting for the factors and other fixed effects</li>
<li>
<code>tot_F_var</code> is the residual variance of the factor
traits, after accounting for any fixed effects. This value is actually
set to 1 in the model, but is introduced as a working parameter in the
algorithm to improve mixing.</li>
<li>
<code>Lambda_prior</code> controls the prior distribution of the
elements of <code>Lambda</code>, the factor loadings matrix</li>
<li>
<code>h2_priors_resids_run</code> and
<code>h2_priors_factors_fun</code> specifies the priors on each variance
component proportion. These need to be specified as functions that take
as input a vector of variance component proportions across all random
effects, and returns a value proportion to the relative prior
probability of that vector relative to any other vector. These values do
not need to be normalized. The second argument, <code>n</code> specifies
the number of discrete values that the prior is evaluated at. This is
not the same as <code>h2_divisions</code> from
<code>MegaLMM_control</code> because it counts the total number of
grid-cells over the entire prior simplex, not the per-variance-componet
number of divisions.</li>
</ul>
<p>Note: <code>MegaLMM_priors</code> can be run after constructing the
<code>MegaLMM</code> model (see below). This can be convenient because
<code>n</code> above in the specification of the <code>h2_priors</code>
functions needs the number of grid-cells in the prior simplex which may
be difficult to calculate by hand. See <code>?MegaLMM_prior</code> for
more details.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">priors</span> <span class="op">=</span> <span class="fu"><a href="../reference/MegaLMM_priors.html">MegaLMM_priors</a></span><span class="op">(</span></span>
<span>  tot_Y_var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>V <span class="op">=</span> <span class="fl">0.5</span>,   nu <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,      <span class="co"># Prior variance of trait residuals after accounting for fixed effects and factors</span></span>
<span>  tot_F_var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>V <span class="op">=</span> <span class="fl">18</span><span class="op">/</span><span class="fl">20</span>, nu <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,     <span class="co"># Prior variance of factor traits. This is included to improve MCMC mixing, but can be turned off by setting nu very large</span></span>
<span>  Lambda_prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    sampler <span class="op">=</span> <span class="va">sample_Lambda_prec_horseshoe</span>, <span class="co"># function that implements the horseshoe-based Lambda prior described in Runcie et al 2020. See code to see requirements for this function.</span></span>
<span>    prop_0 <span class="op">=</span> <span class="fl">0.1</span>,    <span class="co"># prior guess at the number of non-zero loadings in the first and most important factor</span></span>
<span>    delta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fl">3</span>, scale <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,    <span class="co"># parameters of the gamma distribution giving the expected change in proportion of non-zero loadings in each consecutive factor</span></span>
<span>    delta_iterations_factor <span class="op">=</span> <span class="fl">100</span>   <span class="co"># parameter that affects mixing of the MCMC sampler. This value is generally fine.</span></span>
<span>  <span class="op">)</span>,</span>
<span>  h2_priors_resids_fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">h2s</span>,<span class="va">n</span><span class="op">)</span>  <span class="fl">1</span>,  <span class="co"># Function that returns the prior density for any value of the h2s vector (ie the vector of random effect proportional variances across all random effects. 1 means constant prior. Alternative: pmax(pmin(ddirichlet(c(h2s,1-sum(h2s)),rep(2,length(h2s)+1)),10),1e-10),</span></span>
<span>  h2_priors_factors_fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">h2s</span>,<span class="va">n</span><span class="op">)</span> <span class="fl">1</span> <span class="co"># See above. Another choice is one that gives 50% weight to h2==0: ifelse(h2s == 0,n,n/(n-1))</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="construct-the-model">Construct the model<a class="anchor" aria-label="anchor" href="#construct-the-model"></a>
</h2>
<p>The following set of functions actually contructs theh MegaLMM model
and prepares it for sampling.</p>
<p>The first function <code>setup_model_MegaLMM</code> returns an object
of class <code>MegaLMM_state</code> which stores all information about
the MCMC chain. It is a list including the following components:</p>
<ul>
<li>
<code>current_state</code>: a list with elements holding the current
values for all model parameters. Each parameter is stored as a 2d
matrix. Variable names correspond as closely as possible to those
described in the manuscript: Runcie et al 2020.</li>
<li>
<code>Posterior</code>: a list with elements 3d or 2d arrays holding
posterior samples (or posterior means) of specified model parameters. By
default, samples of all parameters are stored. However these matrices
can be large if data is large, so parameters can be dropped from this
list by removing their names from the lists
<code>MegaLMM_state$Posterior$posteriorSample_params</code> and
<code>MegaLMM_state$Posterior$posteriorMean_params</code>.</li>
<li>
<code>run_ID</code>: The current state of the chain plus Posterior
samples and any diagnostic plots are automatically saved in a folder
with this name during the run.</li>
</ul>
<p>Other elements of this list are less useful except for advanced
users:</p>
<ul>
<li>
<code>data_matrices</code>: a list with all the design matrices (and
some extra associated pre-calculated matrices) used for evaluating the
model</li>
<li>
<code>priors</code>: a list with hyperparameters for all prior
distributions</li>
<li>
<code>run_parameters</code>: various statistics specifying the
dimensions and processing steps applied to the data and model
structure</li>
<li>
<code>run_variables</code>: various values that are pre-calculated
and stored for computational efficiency.</li>
</ul>
<p>Setting up the <code>MegaLMM_state</code> object for sampling has
several steps.</p>
<ol style="list-style-type: decimal">
<li>First, you need to specify the model terms using
<code>setup_model_MegaLMM</code>. The design of this function is
intended to be similar to <code>lme4</code> or <code>lme4qtl</code>. We
use R’s formula interface to specify fixed and random effects. However,
for convience and extendability (which will be documented later), we
break up the right and left-hand side of the typical model statement
into two arguments, with the second being the typical right-hand side
(RHS) of a mixed model in R. See <code>?lmer</code> for more details.
However note that correlated random effects are not allowed, so
<code>(1+Fixed1 | animal)</code> and <code>(1+Fixed1 || animal)</code>
are the same. You can also specify covariance matrices for any random
effect grouping variable using the <code>relmat</code> argument.</li>
<li>After specifying the model, there is an optional step to divide the
input matrix <code>Y</code> into chunks with similar patterns of missing
data. This is only useful if there are many NA values in <code>Y</code>,
and these are clumped so groups of observations have the same patterns
of NA and non-NA values. But if this exists, using this can greatly
improve MCMC mixing. The function <code>make_Missing_data_map</code>
tries to guess at the optimal chunk pattern for your data. If you know
it yourself, you can specify the groups directly in
<code>set_Missing_data_map</code>.</li>
<li>Next, you specify the prior hyperparameters using the
<code>set_priors_MegaLMM</code> funciton.</li>
<li>Next, you initialize all parameters of the model using
<code>initialize_variables_MegaLMM</code>.</li>
<li>Next, you run <code>initialize_MegaLMM</code> to pre-calculate many
large matrices that are needed during sampling. This step can take very
long to run and require large amounts of memory if the sample size is
large and/or there are many random effect terms. A progress par is
provided, but it is often important to check R’s memory usage during
this step to identify problems.</li>
<li>Finally, you can initialize the Posterior samples data structures
using <code>clear_Posterior</code>. This isn’t critical if this is the
first time running the model (with this <code>run_ID</code>), but is
good to include in case your directory structure isn’t clean. Note,
though, that if you were hoping to save posterior samples from an
earlier run, this will erase them all!</li>
</ol>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">MegaLMM_state</span> <span class="op">=</span> <span class="fu"><a href="../reference/setup_model_MegaLMM.html">setup_model_MegaLMM</a></span><span class="op">(</span><span class="va">Y</span>,            <span class="co"># n x p data matrix</span></span>
<span>                              <span class="op">~</span><span class="va">Fixed1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">animal</span><span class="op">)</span>,  <span class="co"># RHS of base model for factors and residuals. Fixed effects defined here only apply to the factor residuals.</span></span>
<span>                              data <span class="op">=</span> <span class="va">data</span>,         <span class="co"># the data.frame with information for constructing the model matrices</span></span>
<span>                              relmat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>animal <span class="op">=</span> <span class="va">K</span><span class="op">)</span>, <span class="co"># covariance matrices for the random effects. If not provided, assume uncorrelated</span></span>
<span>                              run_parameters<span class="op">=</span><span class="va">run_parameters</span>,</span>
<span>                              run_ID <span class="op">=</span> <span class="st">'MegaLMM_example'</span></span>
<span>                                <span class="op">)</span></span>
<span><span class="va">maps</span> <span class="op">=</span> <span class="fu">make_Missing_data_map</span><span class="op">(</span><span class="va">MegaLMM_state</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   map N_groups max_group_size total_kept_NAs</span></span>
<span><span class="co">## 1   1        1            500              0</span></span></code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">MegaLMM_state</span> <span class="op">=</span> <span class="fu">set_Missing_data_map</span><span class="op">(</span><span class="va">MegaLMM_state</span>,<span class="va">maps</span><span class="op">$</span><span class="va">Missing_data_map</span><span class="op">)</span></span>
<span></span>
<span><span class="va">MegaLMM_state</span> <span class="op">=</span> <span class="fu"><a href="../reference/set_priors_MegaLMM.html">set_priors_MegaLMM</a></span><span class="op">(</span><span class="va">MegaLMM_state</span>,<span class="va">priors</span><span class="op">)</span>  <span class="co"># apply the priors</span></span>
<span><span class="va">MegaLMM_state</span> <span class="op">=</span> <span class="fu"><a href="../reference/initialize_variables_MegaLMM.html">initialize_variables_MegaLMM</a></span><span class="op">(</span><span class="va">MegaLMM_state</span><span class="op">)</span> <span class="co"># initialize the model</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "initializing Lambda_prec horseshoe"</span></span>
<span><span class="co">## [1] "initializing B_prec horseshoe"</span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">MegaLMM_state</span> <span class="op">=</span> <span class="fu"><a href="../reference/initialize_MegaLMM.html">initialize_MegaLMM</a></span><span class="op">(</span><span class="va">MegaLMM_state</span><span class="op">)</span> <span class="co"># run the initial calculations</span></span></code></pre></div>
<pre><code>## [1] "Pre-calculating random effect inverse matrices for 1 groups of traits and 20 sets of random effect weights"
## 
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |====                                                                  |   5%
  |                                                                            
  |=======                                                               |  10%
  |                                                                            
  |==========                                                            |  15%
  |                                                                            
  |==============                                                        |  20%
  |                                                                            
  |==================                                                    |  25%
  |                                                                            
  |=====================                                                 |  30%
  |                                                                            
  |========================                                              |  35%
  |                                                                            
  |============================                                          |  40%
  |                                                                            
  |================================                                      |  45%
  |                                                                            
  |===================================                                   |  50%
  |                                                                            
  |======================================================================| 100%</code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">MegaLMM_state</span> <span class="op">=</span> <span class="fu"><a href="../reference/clear_Posterior.html">clear_Posterior</a></span><span class="op">(</span><span class="va">MegaLMM_state</span><span class="op">)</span> <span class="co"># prepare the output directories</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="run-mcmc">Run MCMC<a class="anchor" aria-label="anchor" href="#run-mcmc"></a>
</h2>
<p>Now (finally!) you’re ready to run the MCMC chain.</p>
<p>A MCMC chain is a way of fitting parameters from a Bayesian model The
chain is a sequence of draws from the Posterior distribution of each
parameter. MegaLMM uses a Gibbs sampler, which means that we iterate
through all of the model’s parameters and for each parameter draw a new
value from it’s posterior holding all other parameters constant This
works, but the individual draws are not independent draws from the joint
posterior of all parameters. Therefore, to get independent draws, we
have to collect many posterior samples, and then save only a portion of
them. Also, it may take many iterations for the MCMC chain to converge
to the central part of the distribution. This is the burnin period, and
we do not store these values (they are not useful). At the end, we have
a collection of samples from the posterior distribution of each
parameter. We can use these samples to characterize each distribution:
mean, SD, histogram, HPDinterval, etc.</p>
<p>The way MegaLMM works is that you ask the program to collect a small
number of samples And then can assess how the chain is performing (how
well it is mixing, is it converged?) And then either save the samples as
posterior samples, or declare them as burn-in and discard them. Then,
you can ask for more samples, and repeat until you have enough.</p>
<div class="section level3">
<h3 id="tools-for-re-setting-posterior-samples-and-helping-chain-converge">Tools for re-setting Posterior samples, and helping chain
converge<a class="anchor" aria-label="anchor" href="#tools-for-re-setting-posterior-samples-and-helping-chain-converge"></a>
</h3>
<p><code>MegaLMM_state = clear_Posterior(MegaLMM_state)</code></p>
<p><code>MegaLMM_state = reorder_factors(MegaLMM_state)</code></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The following code is optional, but tries to guess for your system how many CPUs to use for fastest processing</span></span>
<span><span class="co"># (n_threads = optimize_n_threads(MegaLMM_state,seq(1,RcppParallel::defaultNumThreads(),by=1),times=2))</span></span>
<span><span class="co"># set_MegaLMM_nthreads(n_threads$optim)</span></span>
<span><span class="co"># now do sampling is smallish chunks</span></span>
<span><span class="va">n_iter</span> <span class="op">=</span> <span class="fl">100</span>;  <span class="co"># how many samples to collect at once?</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span>  <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">'Run %d'</span>,<span class="va">i</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">MegaLMM_state</span> <span class="op">=</span> <span class="fu"><a href="../reference/sample_MegaLMM.html">sample_MegaLMM</a></span><span class="op">(</span><span class="va">MegaLMM_state</span>,<span class="va">n_iter</span><span class="op">)</span>  <span class="co"># run MCMC chain n_samples iterations. grainSize is a paramter for parallelization (smaller = more parallelization)</span></span>
<span>  </span>
<span>  <span class="va">U</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">setup</span>,<span class="va">U_F</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">Lambda</span><span class="op">+</span><span class="va">U_R</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">U</span>,<span class="fu"><a href="../reference/get_posterior_mean.html">get_posterior_mean</a></span><span class="op">(</span><span class="va">MegaLMM_state</span><span class="op">$</span><span class="va">Posterior</span><span class="op">$</span><span class="va">U</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">MegaLMM_state</span> <span class="op">=</span> <span class="fu"><a href="../reference/save_posterior_chunk.html">save_posterior_chunk</a></span><span class="op">(</span><span class="va">MegaLMM_state</span><span class="op">)</span>  <span class="co"># save any accumulated posterior samples in the database to release memory</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">MegaLMM_state</span><span class="op">)</span> <span class="co"># print status of current chain</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">MegaLMM_state</span>,setup <span class="op">=</span> <span class="va">setup</span><span class="op">)</span> <span class="co"># make some diagnostic plots. These are saved in a pdf booklet: diagnostic_plots.pdf</span></span>
<span></span>
<span>  </span>
<span>  <span class="co"># set of commands to run during burn-in period to help chain converge</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">MegaLMM_state</span><span class="op">$</span><span class="va">current_state</span><span class="op">$</span><span class="va">nrun</span> <span class="op">&lt;</span> <span class="va">MegaLMM_state</span><span class="op">$</span><span class="va">run_parameters</span><span class="op">$</span><span class="va">burn</span> <span class="op">||</span> <span class="va">i</span> <span class="op">&lt;</span> <span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">MegaLMM_state</span> <span class="op">=</span> <span class="fu"><a href="../reference/reorder_factors.html">reorder_factors</a></span><span class="op">(</span><span class="va">MegaLMM_state</span>,drop_cor_threshold <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="co"># Factor order doesn't "mix" well in the MCMC. We can help it by manually re-ordering from biggest to smallest</span></span>
<span>    <span class="va">MegaLMM_state</span> <span class="op">=</span> <span class="fu"><a href="../reference/clear_Posterior.html">clear_Posterior</a></span><span class="op">(</span><span class="va">MegaLMM_state</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">MegaLMM_state</span><span class="op">$</span><span class="va">run_parameters</span><span class="op">$</span><span class="va">burn</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in cor(F): the standard deviation is zero</span></span>
<span></span>
<span><span class="co">## Warning in cor(F): the standard deviation is zero</span></span></code></pre>
<p><img src="Running_MegaLMM_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Because this was a simulation, we can make some special diagnostic plots by passing in the true values</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">MegaLMM_state</span>,setup <span class="op">=</span> <span class="va">setup</span><span class="op">)</span> </span></code></pre></div>
<p>Look for the output in the <code>MegaLMM_example</code> (our
<code>run_ID</code>) directory.</p>
</div>
</div>
<div class="section level2">
<h2 id="work-with-the-posterior-samples">Work with the Posterior samples<a class="anchor" aria-label="anchor" href="#work-with-the-posterior-samples"></a>
</h2>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># reload the whole database of posterior samples</span></span>
<span><span class="va">MegaLMM_state</span><span class="op">$</span><span class="va">Posterior</span> <span class="op">=</span> <span class="fu"><a href="../reference/reload_Posterior.html">reload_Posterior</a></span><span class="op">(</span><span class="va">MegaLMM_state</span><span class="op">)</span></span>
<span><span class="va">U_hat</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_posterior_mean.html">get_posterior_mean</a></span><span class="op">(</span><span class="va">MegaLMM_state</span>,<span class="va">U_R</span> <span class="op">+</span> <span class="va">U_F</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">Lambda</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># all parameter names in Posterior</span></span>
<span><span class="va">MegaLMM_state</span><span class="op">$</span><span class="va">Posterior</span><span class="op">$</span><span class="va">posteriorSample_params</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "Lambda"       "U_F"          "F"            "delta"        "tot_F_prec"  </span></span>
<span><span class="co">##  [6] "F_h2"         "tot_Eta_prec" "resid_h2"     "B1"           "B2_F"        </span></span>
<span><span class="co">## [11] "B2_R"         "U_R"          "cis_effects"  "Lambda_m_eff" "Eta"</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">MegaLMM_state</span><span class="op">$</span><span class="va">Posterior</span><span class="op">$</span><span class="va">posteriorMean_params</span>  <span class="co"># these ones only have the posterior mean saved, not individual posterior samples</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "Eta_mean"</span></span></code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># instead, load only a specific parameter</span></span>
<span><span class="va">Lambda</span> <span class="op">=</span> <span class="fu"><a href="../reference/load_posterior_param.html">load_posterior_param</a></span><span class="op">(</span><span class="va">MegaLMM_state</span>,<span class="st">'Lambda'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># boxplots are good ways to visualize Posterior distributions on sets of related parameters</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html" class="external-link">boxplot</a></span><span class="op">(</span><span class="va">MegaLMM_state</span><span class="op">$</span><span class="va">Posterior</span><span class="op">$</span><span class="va">F_h2</span><span class="op">[</span>,<span class="fl">1</span>,<span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="Running_MegaLMM_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get posterior distribution on a function of parameters</span></span>
<span><span class="co"># This is how to calculate the G-matrix for random effect #1 (ie animal above.)</span></span>
<span><span class="va">G_samples</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_posterior_FUN.html">get_posterior_FUN</a></span><span class="op">(</span><span class="va">MegaLMM_state</span>,<span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">Lambda</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">F_h2</span><span class="op">[</span><span class="st">'animal'</span>,<span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">Lambda</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">resid_h2</span><span class="op">[</span><span class="st">'animal'</span>,<span class="op">]</span><span class="op">/</span><span class="va">tot_Eta_prec</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get posterior mean of a parameter</span></span>
<span><span class="va">G</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_posterior_mean.html">get_posterior_mean</a></span><span class="op">(</span><span class="va">G_samples</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get Highest Posterior Density intervals for paramters</span></span>
<span><span class="va">F_h2_HPD</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_posterior_HPDinterval.html">get_posterior_HPDinterval</a></span><span class="op">(</span><span class="va">MegaLMM_state</span>,<span class="va">F_h2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># make a boxplot to summarize a subset of parameters.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html" class="external-link">boxplot</a></span><span class="op">(</span><span class="va">MegaLMM_state</span><span class="op">$</span><span class="va">Posterior</span><span class="op">$</span><span class="va">B1</span><span class="op">[</span>,<span class="fl">1</span>,<span class="op">]</span>,outline<span class="op">=</span><span class="cn">F</span><span class="op">)</span>;<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p><img src="Running_MegaLMM_files/figure-html/unnamed-chunk-9-2.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Daniel E Runcie.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
